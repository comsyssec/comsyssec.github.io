{%- comment -%}
공통 변수
{%- endcomment -%}
{%- assign all_items = site.gallery | sort: "date" | reverse -%}
{%- assign page_size = 10 -%}
{%- assign current = page.page_index | default: 1 | plus: 0 -%}
{%- assign offset = current | minus: 1 | times: page_size -%}

{%- comment -%}
전체 페이지 수 계산: ((N-1)/page_size)+1
{%- endcomment -%}
{%- assign total = all_items.size -%}
{%- assign last_idx = total | minus: 1 -%}
{%- assign base_pages = last_idx | divided_by: page_size -%}
{%- assign total_pages = base_pages | plus: 1 -%}
{%- if total == 0 -%}{% assign total_pages = 1 %}{%- endif -%}

{%- comment -%}
태그 목록 수집
{%- endcomment -%}
{%- assign all_tags_csv = "" -%}
{%- for it in all_items -%}
  {%- if it.tags -%}
    {%- for t in it.tags -%}
      {%- unless all_tags_csv contains t -%}
        {%- assign all_tags_csv = all_tags_csv | append: t | append: "," -%}
      {%- endunless -%}
    {%- endfor -%}
  {%- endif -%}
{%- endfor -%}
{%- assign all_tags = all_tags_csv | split: "," | sort -%}

<div class="gallery-toolbar">
  <button class="gfilter is-active" data-tag="*">All</button>
  {%- for t in all_tags -%}
    {%- if t != "" -%}
      <button class="gfilter" data-tag="{{ t | escape }}">{{ t }}</button>
    {%- endif -%}
  {%- endfor -%}
</div>

<ul class="gallery-grid">
  {%- assign prev_year = "" -%}
  {%- for g in all_items limit: page_size offset: offset -%}
    {%- assign y = g.date | date: "%Y" -%}
    {%- if y != prev_year -%}
      <li class="gallery-year">{{ y }}</li>
      {%- assign prev_year = y -%}
    {%- endif -%}
    {%- if g.images -%}
      {%- for img in g.images -%}
        <li class="gallery-card" data-tags="{{ g.tags | join: ' ' }}">
          <a href="{{ g.image }}" class="glink" data-index="{{ forloop.index0 }}" data-title="{{ g.title | escape }}" data-caption="{{ g.caption | escape }}">
            <img src="{{ img }}" alt="{{ g.title | escape }}">
          </a>
          <div class="gmeta">
            <div class="gtitle">{{ g.title }}</div>
            {%- if g.caption -%}<div class="gcap">{{ g.caption }}</div>{%- endif -%}
            <div class="gdate">{{ g.date | date: "%b %d, %Y" }}</div>
          </div>
        </li>
      {%- endfor -%}

    {%- else -%}
      <li class="gallery-card" data-tags="{{ g.tags | join: ' ' }}">
        <a href="{{ g.image }}" class="glink" data-index="0" data-title="{{ g.title | escape }}" data-caption="{{ g.caption | escape }}">
          <img src="{{ g.image }}" alt="{{ g.title | escape }}">
        </a>
        <div class="gmeta">
          <div class="gtitle">{{ g.title }}</div>
          {%- if g.caption -%}<div class="gcap">{{ g.caption }}</div>{%- endif -%}
          <div class="gdate">{{ g.date | date: "%b %d, %Y" }}</div>
        </div>
      </li>
    {%- endif -%}
    {%- endfor -%}
</ul>

{%- if total_pages > 1 -%}
<nav class="pager" aria-label="Gallery pagination">
  {%- assign base = "/gallery" -%}
  {%- assign first_href = base | append: "/" -%}
  {%- assign prev_href  = base | append: "/page/" | append: current | minus: 1 | append: "/" -%}
  {%- assign next_href  = base | append: "/page/" | append: current | plus: 1 | append: "/" -%}

  <a class="pbtn" href="{{ first_href }}" {% if current == 1 %}aria-disabled="true"{% endif %}>&laquo; First</a>
  <a class="pbtn" href="{% if current == 2 %}{{ first_href }}{% else %}{{ prev_href }}{% endif %}" {% if current == 1 %}aria-disabled="true"{% endif %}>&lsaquo; Prev</a>

  <span class="ppage">Page {{ current }} / {{ total_pages }}</span>

  <a class="pbtn" href="{{ next_href }}" {% if current == total_pages %}aria-disabled="true"{% endif %}>Next &rsaquo;</a>
  <a class="pbtn" href="{{ base }}/page/{{ total_pages }}/" {% if current == total_pages %}aria-disabled="true"{% endif %}>Last &raquo;</a>
</nav>
{%- endif -%}

<!-- 라이트박스 -->
<div id="lightbox" class="lightbox" hidden>
  <div class="lb-backdrop" data-close></div>
  
  <button id="lb-prev" class="lb-nav" aria-label="Previous">&#10094;</button>
  <button id="lb-next" class="lb-nav" aria-label="Next">&#10095;</button>
  
  <figure class="lb-figure">
    <img id="lb-img" alt="">
    <figcaption id="lb-cap"></figcaption>
    <button class="lb-close" aria-label="Close" data-close>&times;</button>
  </figure>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // Collect all gallery links
  const links = Array.from(document.querySelectorAll('.glink'));

  const lb = document.getElementById('lightbox');
  const lbImg = document.getElementById('lb-img');
  const lbCap = document.getElementById('lb-cap');
  const btnPrev = document.getElementById('lb-prev');
  const btnNext = document.getElementById('lb-next');

  let currentIndex = 0;

  function openLightbox(index) {
    currentIndex = index;
    const link = links[index];

    lbImg.src = link.href;
    const title = link.dataset.title || '';
    const cap = link.dataset.caption || '';
    lbCap.textContent = title + (cap ? ' — ' + cap : '');

    lb.removeAttribute('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    lb.setAttribute('hidden', '');
    document.body.style.overflow = '';
  }

  function showNext() {
    currentIndex = (currentIndex + 1) % links.length;
    openLightbox(currentIndex);
  }

  function showPrev() {
    currentIndex = (currentIndex - 1 + links.length) % links.length;
    openLightbox(currentIndex);
  }

  links.forEach((link, i) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      openLightbox(i);
    });
  });

  btnNext.addEventListener('click', showNext);
  btnPrev.addEventListener('click', showPrev);

  lb.addEventListener('click', (e) => {
    if (e.target.hasAttribute('data-close')) closeLightbox();
  });

  document.addEventListener('keydown', (e) => {
    if (lb.hidden) return;

    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowRight') showNext();
    if (e.key === 'ArrowLeft') showPrev();
  });

});
</script>

